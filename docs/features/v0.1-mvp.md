# v0.1 MVP - Product Requirements Document

## Overview

The MVP delivers a unified CLI (`cm`) that validates code quality, process compliance, and developer environment across TypeScript and Python projects.

## Goals

1. Single command to run all configured checks: `cm check`
2. Domain-specific commands: `cm code check`, `cm process check`, `cm stack check`
3. Configuration via `check.toml`
4. Clear, actionable output with exit codes for CI integration

## Non-Goals (deferred to later versions)

- Auto-fixing violations (`cm fix`)
- Remote config inheritance (`[extends]`)
- MCP server integration
- Formatting checks (Prettier, Black)

---

## Features

### 1. Configuration File: `check.toml`

Single configuration file at project root.

```toml
[code.linting]
eslint = true
ruff = true

[code.types]
tsc = true

[process.pr]
max_files = 20
max_lines = 400
min_approvals = 1

[process.branches]
pattern = "^(feature|fix|hotfix)/[A-Z]+-[0-9]+-[a-z0-9-]+$"

[process.tickets]
pattern = "[A-Z]+-[0-9]+"
check_in = ["title", "branch", "body"]

[stack.tools]
node = "20"
```

#### Config Discovery

1. Look for `check.toml` in current directory
2. Walk up directory tree until found or reach filesystem root
3. Error if no config found

---

### 2. Code Domain: `cm code check`

#### 2.1 Linting: `[code.linting]`

| Tool | Condition | Action |
|------|-----------|--------|
| ESLint | `eslint = true` | Run `eslint .` with project config |
| Ruff | `ruff = true` | Run `ruff check .` |

**Behavior:**
- Skip tool if not installed (warn, don't fail)
- Use project's existing config (eslint.config.js, ruff.toml)
- Collect violations, report in unified format

#### 2.2 Type Checking: `[code.types]`

| Tool | Condition | Action |
|------|-----------|--------|
| tsc | `tsc = true` | Run `tsc --noEmit` |

**Behavior:**
- Skip if no `tsconfig.json` found (warn)
- Report type errors in unified format

#### Output Format

```
[code.linting] ESLint
  ✗ src/index.ts:10:5 - 'foo' is assigned but never used (@typescript-eslint/no-unused-vars)
  ✗ src/utils.ts:25:1 - Missing return type (@typescript-eslint/explicit-function-return-type)

[code.linting] Ruff
  ✗ src/main.py:15:1 - F401 'os' imported but unused

[code.types] tsc
  ✗ src/index.ts:20:10 - Type 'string' is not assignable to type 'number'

code: 4 violations found
```

---

### 3. Process Domain: `cm process check`

Validates PR/branch against configured policies. Requires GitHub context (branch name, PR number).

#### 3.1 PR Checks: `[process.pr]`

| Check | Config | Data Source |
|-------|--------|-------------|
| Max files changed | `max_files = 20` | GitHub API |
| Max lines changed | `max_lines = 400` | GitHub API |
| Min approvals | `min_approvals = 1` | GitHub API |

#### 3.2 Branch Naming: `[process.branches]`

| Check | Config | Data Source |
|-------|--------|-------------|
| Pattern match | `pattern = "^(feature|fix)..."` | Current branch name |

#### 3.3 Ticket Reference: `[process.tickets]`

| Check | Config | Data Source |
|-------|--------|-------------|
| Pattern in locations | `pattern`, `check_in` | PR title, body, branch |

**Behavior:**
- If not in PR context (no `GITHUB_*` env vars), skip PR-specific checks
- Branch checks work locally
- Ticket pattern checked in configured locations

#### Output Format

```
[process.pr]
  ✗ PR has 35 files changed (max: 20)
  ✓ PR has 280 lines changed (max: 400)
  ✗ PR has 0 approvals (min: 1)

[process.branches]
  ✓ Branch 'feature/ABC-123-add-login' matches pattern

[process.tickets]
  ✓ Ticket 'ABC-123' found in branch

process: 2 violations found
```

---

### 4. Stack Domain: `cm stack check`

Validates local development environment.

#### 4.1 Tool Versions: `[stack.tools]`

| Check | Config | Action |
|-------|--------|--------|
| Node.js version | `node = "20"` | Run `node --version`, compare major |

**Version Matching:**
- `"20"` - Major version match (20.x.x)
- `"20.10"` - Major.minor match (20.10.x)
- `"20.10.0"` - Exact match

**Behavior:**
- Tool not installed = violation
- Version mismatch = violation
- Report installed vs required version

#### Output Format

```
[stack.tools]
  ✓ node: 20.11.0 (required: 20)
  ✗ npm: not installed (required: 10)

stack: 1 violation found
```

---

### 5. Unified Command: `cm check`

Runs all three domains in sequence.

```bash
$ cm check

[code.linting] ESLint
  ✗ src/index.ts:10:5 - 'foo' is assigned but never used

[code.types] tsc
  ✓ No type errors

[process.branches]
  ✓ Branch 'feature/ABC-123-add-login' matches pattern

[stack.tools]
  ✓ node: 20.11.0 (required: 20)

Summary:
  code: 1 violation
  process: 0 violations
  stack: 0 violations

Total: 1 violation
```

---

### 6. CLI Interface

#### Commands

| Command | Description |
|---------|-------------|
| `cm check` | Run all checks |
| `cm code check` | Run code checks only |
| `cm process check` | Run process checks only |
| `cm stack check` | Run stack checks only |
| `cm init` | Create check.toml with defaults |
| `cm --version` | Print version |
| `cm --help` | Print help |

#### Flags

| Flag | Description |
|------|-------------|
| `--json` | Output as JSON |
| `--quiet` | Exit code only, no output |
| `--ci` | CI mode (strict, fail fast) |
| `--config <path>` | Path to check.toml |

#### Exit Codes

| Code | Meaning |
|------|---------|
| 0 | All checks passed |
| 1 | Violations found |
| 2 | Configuration error |
| 3 | Runtime error (tool missing, API failure) |

---

### 7. JSON Output

When `--json` flag is used:

```json
{
  "version": "0.1.0",
  "config": "check.toml",
  "domains": {
    "code": {
      "status": "fail",
      "violations": [
        {
          "rule": "code.linting.eslint",
          "tool": "eslint",
          "file": "src/index.ts",
          "line": 10,
          "column": 5,
          "message": "'foo' is assigned but never used",
          "code": "@typescript-eslint/no-unused-vars"
        }
      ]
    },
    "process": {
      "status": "pass",
      "violations": []
    },
    "stack": {
      "status": "pass",
      "violations": []
    }
  },
  "summary": {
    "total_violations": 1,
    "exit_code": 1
  }
}
```

---

## Technical Design

### Architecture

```
src/
├── cli/
│   ├── index.ts          # Entry point, Commander setup
│   ├── commands/
│   │   ├── check.ts      # cm check
│   │   ├── code.ts       # cm code check
│   │   ├── process.ts    # cm process check
│   │   ├── stack.ts      # cm stack check
│   │   └── init.ts       # cm init
│   └── output/
│       ├── text.ts       # Human-readable output
│       └── json.ts       # JSON output
├── config/
│   ├── loader.ts         # Find and load check.toml
│   ├── schema.ts         # Zod schema for config
│   └── defaults.ts       # Default values
├── domains/
│   ├── code/
│   │   ├── index.ts      # Code domain runner
│   │   ├── linting.ts    # ESLint, Ruff runners
│   │   └── types.ts      # tsc runner
│   ├── process/
│   │   ├── index.ts      # Process domain runner
│   │   ├── pr.ts         # PR checks
│   │   ├── branches.ts   # Branch naming
│   │   └── tickets.ts    # Ticket references
│   └── stack/
│       ├── index.ts      # Stack domain runner
│       └── tools.ts      # Tool version checks
└── types/
    └── index.ts          # Shared types (Violation, Result, etc.)
```

### Dependencies

| Package | Purpose |
|---------|---------|
| commander | CLI framework |
| @iarna/toml | TOML parsing |
| zod | Config validation |
| chalk | Colored output |
| execa | Running external tools |
| @octokit/rest | GitHub API |

### Tool Execution

Tools are executed via `execa` with:
- Timeout: 5 minutes per tool
- Working directory: project root
- Output captured and parsed

### GitHub Context

PR information from environment variables:
- `GITHUB_REF` - Branch ref
- `GITHUB_HEAD_REF` - PR head branch
- `GITHUB_EVENT_PATH` - PR event payload
- `GITHUB_TOKEN` - API authentication

If not in GitHub Actions, PR checks are skipped with a warning.

---

## Acceptance Criteria

### Must Have

- [ ] `cm check` runs all configured checks
- [ ] `cm code check` runs ESLint and tsc
- [ ] `cm process check` validates branch naming
- [ ] `cm stack check` validates Node.js version
- [ ] `check.toml` config file is parsed and validated
- [ ] Exit code 0 when all checks pass
- [ ] Exit code 1 when violations found
- [ ] `--json` flag outputs valid JSON
- [ ] Works in GitHub Actions CI

### Should Have

- [ ] Ruff integration for Python
- [ ] PR size checks (files, lines)
- [ ] Ticket reference validation
- [ ] Colored terminal output
- [ ] `--quiet` flag

### Nice to Have

- [ ] `cm init` generates starter config
- [ ] Config file discovery (walk up tree)
- [ ] Multiple tool version formats (20, 20.10, 20.10.0)

---

## Testing Strategy

### Unit Tests

- Config parsing and validation
- Version comparison logic
- Output formatting
- Branch pattern matching

### Integration Tests

- ESLint execution and output parsing
- tsc execution and output parsing
- GitHub API mocking for PR checks

### E2E Tests

- Full `cm check` run on sample project
- CI environment simulation
- JSON output validation

---

## Rollout Plan

1. **Alpha**: Internal testing on 2-3 projects
2. **Beta**: Publish to npm as `@anthropic/check-my-toolkit`
3. **GA**: Announce, documentation site

---

## Open Questions

1. Should we support `ruff` in MVP or defer to v0.2?
2. How to handle monorepos with multiple `check.toml` files?
3. Should `--ci` flag be default when `CI=true` env var is set?
