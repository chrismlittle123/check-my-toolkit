# v0.1 MVP - CODE Domain

## Overview

The MVP delivers a unified CLI (`cm`) focused entirely on **CODE domain** validation: linting, type checking, and config auditing for TypeScript and Python projects.

## Goals

1. Single command to run code checks: `cm check` / `cm code check`
2. Single command to verify configs exist: `cm audit` / `cm code audit`
3. Configuration via `check.toml`
4. Clear, actionable output with exit codes for CI integration

## Non-Goals (deferred to later versions)

- Auto-fixing violations (`cm fix`)
- Remote config inheritance (`[extends]`)
- MCP server integration
- Formatting checks (Prettier, Black)
- PROCESS domain (PR checks, branch naming, tickets)
- STACK domain (tool versions, services, env vars)

---

## Features

### 1. Configuration File: `check.toml`

Single configuration file at project root.

```toml
[code.linting]
eslint = true
ruff = true

[code.types]
tsc = true
```

#### Config Discovery

1. Look for `check.toml` in current directory
2. Walk up directory tree until found or reach filesystem root
3. Error if no config found

---

### 2. Code Domain: `cm code check`

#### 2.1 Linting: `[code.linting]`

| Tool | Condition | Action |
|------|-----------|--------|
| ESLint | `eslint = true` | Run `eslint .` with project config |
| Ruff | `ruff = true` | Run `ruff check .` |

**Behavior:**
- Skip tool if not installed (warn, don't fail)
- Use project's existing config (eslint.config.js, ruff.toml)
- Collect violations, report in unified format

#### 2.2 Type Checking: `[code.types]`

| Tool | Condition | Action |
|------|-----------|--------|
| tsc | `tsc = true` | Run `tsc --noEmit` |

**Behavior:**
- Skip if no `tsconfig.json` found (warn)
- Report type errors in unified format

#### Output Format

```
[code.linting] ESLint
  ✗ src/index.ts:10:5 - 'foo' is assigned but never used (@typescript-eslint/no-unused-vars)
  ✗ src/utils.ts:25:1 - Missing return type (@typescript-eslint/explicit-function-return-type)

[code.linting] Ruff
  ✗ src/main.py:15:1 - F401 'os' imported but unused

[code.types] tsc
  ✗ src/index.ts:20:10 - Type 'string' is not assignable to type 'number'

code: 4 violations found
```

---

### 3. Unified Command: `cm check`

In v0.1, `cm check` is equivalent to `cm code check` since only CODE domain is implemented.

```bash
$ cm check

[code.linting] ESLint
  ✗ src/index.ts:10:5 - 'foo' is assigned but never used

[code.types] tsc
  ✓ No type errors

Summary:
  code: 1 violation

Total: 1 violation
```

---

### 4. Audit Command: `cm audit`

Verifies configs exist and match `check.toml` without running any tools. Fast, no external dependencies.

#### What it checks

| Check | Description |
|-------|-------------|
| Config exists | eslint.config.js, ruff.toml, tsconfig.json exist |
| Config matches | Generated config would match check.toml rules |
| Required files | Files in `[code.files]` exist |

#### Output Format

```
$ cm audit

[code.linting]
  ✓ eslint.config.js exists
  ✗ ruff.toml missing

[code.types]
  ✓ tsconfig.json exists

[code.files]
  ✓ README.md exists
  ✗ LICENSE missing

audit: 2 issues found
```

#### Use Cases

1. **Fast pre-check**: Run before `cm check` to fail fast on missing configs
2. **CI gate**: Ensure project setup is complete before running expensive checks
3. **Onboarding**: New developer runs `cm audit` to see what's missing

---

### 5. CLI Interface

#### Commands

| Command | Description |
|---------|-------------|
| `cm check` | Run all checks (CODE only in v0.1) |
| `cm audit` | Verify configs exist (no tool execution) |
| `cm code check` | Run code checks |
| `cm code audit` | Verify code configs exist |
| `cm init` | Create check.toml with defaults |
| `cm --version` | Print version |
| `cm --help` | Print help |

#### Flags

| Flag | Description |
|------|-------------|
| `--format` | Output format: `text` (default) or `json` |

#### Exit Codes

| Code | Meaning |
|------|---------|
| 0 | All checks passed |
| 1 | Violations found |
| 2 | Configuration error |
| 3 | Runtime error (tool missing, API failure) |

---

### 6. JSON Output

When `--json` flag is used:

```json
{
  "version": "0.1.0",
  "config": "check.toml",
  "domains": {
    "code": {
      "status": "fail",
      "violations": [
        {
          "rule": "code.linting.eslint",
          "tool": "eslint",
          "file": "src/index.ts",
          "line": 10,
          "column": 5,
          "message": "'foo' is assigned but never used",
          "code": "@typescript-eslint/no-unused-vars"
        }
      ]
    }
  },
  "summary": {
    "total_violations": 1,
    "exit_code": 1
  }
}
```

---

## Technical Design

### Architecture

```
src/
├── cli/
│   ├── index.ts          # Entry point, Commander setup
│   ├── commands/
│   │   ├── check.ts      # cm check
│   │   ├── audit.ts      # cm audit
│   │   ├── code.ts       # cm code check, cm code audit
│   │   └── init.ts       # cm init
│   └── output/
│       ├── text.ts       # Human-readable output
│       └── json.ts       # JSON output
├── config/
│   ├── loader.ts         # Find and load check.toml
│   ├── schema.ts         # Zod schema for config
│   └── defaults.ts       # Default values
├── domains/
│   └── code/
│       ├── index.ts      # Code domain runner
│       ├── linting.ts    # ESLint, Ruff runners
│       └── types.ts      # tsc runner
└── types/
    └── index.ts          # Shared types (Violation, Result, etc.)
```

### Dependencies

| Package | Purpose |
|---------|---------|
| commander | CLI framework |
| @iarna/toml | TOML parsing |
| zod | Config validation |
| chalk | Colored output |
| execa | Running external tools |

### Tool Execution

Tools are executed via `execa` with:
- Timeout: 5 minutes per tool
- Working directory: project root
- Output captured and parsed

---

## Acceptance Criteria

### Must Have

- [ ] `cm check` runs all configured checks
- [ ] `cm audit` verifies configs exist without running tools
- [ ] `cm code check` runs ESLint and tsc
- [ ] `cm code audit` verifies code configs exist
- [ ] `check.toml` config file is parsed and validated
- [ ] Exit code 0 when all checks pass
- [ ] Exit code 1 when violations found
- [ ] `--json` flag outputs valid JSON
- [ ] Works in GitHub Actions CI

### Should Have

- [ ] Ruff integration for Python
- [ ] Colored terminal output

### Nice to Have

- [ ] `cm init` generates starter config
- [ ] Config file discovery (walk up tree)

---

## Testing Strategy

### Unit Tests

- Config parsing and validation
- Output formatting

### Integration Tests

- ESLint execution and output parsing
- tsc execution and output parsing

### E2E Tests

- Full `cm check` run on sample project
- CI environment simulation
- JSON output validation

---

## Open Questions

1. Should we support `ruff` in MVP or defer to v0.2?
2. How to handle monorepos with multiple `check.toml` files?
