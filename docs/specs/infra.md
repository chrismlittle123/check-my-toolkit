# INFRA Domain Spec

Verify declared AWS infrastructure exists.

## Overview

The INFRA domain validates that resources declared by your infrastructure code actually exist in AWS. It is **IaC-agnostic** - works with CDK, SST, Terraform, Pulumi, CloudFormation, or any tool that can output a manifest of resource ARNs.

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────┐
│   infra/        │ ──────▶ │  manifest.json  │ ──────▶ │  cm infra   │
│   (any IaC)     │ outputs │  (ARN list)     │ checks  │  scan       │
└─────────────────┘         └─────────────────┘         └─────────────┘
                                                              │
                                                              ▼
                                                        ┌─────────────┐
                                                        │    AWS      │
                                                        │  (exists?)  │
                                                        └─────────────┘
```

**The contract:** Your `infra/` package outputs a manifest of ARNs. `cm infra scan` checks if they exist.

---

## Manifest Format

The manifest is generated by your infrastructure package. It lists all resource ARNs that should exist.

### JSON Format

```json
{
  "project": "my-app",
  "resources": [
    "arn:aws:s3:::my-app-data-prod",
    "arn:aws:dynamodb:us-east-1:333333333333:table/my-app-users",
    "arn:aws:lambda:us-east-1:333333333333:function:my-app-api"
  ]
}
```

### Text Format (Alternative)

```
# infra-manifest.txt
arn:aws:s3:::my-app-data-prod
arn:aws:dynamodb:us-east-1:333333333333:table/my-app-users
arn:aws:lambda:us-east-1:333333333333:function:my-app-api
```

### Generating the Manifest

The manifest generation is the responsibility of your `infra/` package. Examples:

**SST:**

```typescript
// Hook after deploy to output manifest
const arns = resources.map((r) => r.arn);
await fs.writeFile(
  "infra-manifest.json",
  JSON.stringify({ project: "my-app", resources: arns })
);
```

**CDK:**

```typescript
// Post-synth script parsing cdk.out/*.template.json
// Extract physical resource IDs and construct ARNs
```

**Terraform:**

```bash
terraform output -json | jq '[.[] | select(.arn) | .arn]' > infra-manifest.json
```

---

## Configuration

```toml
[infra]
enabled = true
manifest = "infra-manifest.json"   # Path to manifest file
```

That's it.

---

## Command

### `cm infra scan`

Checks that all resources in the manifest exist in AWS.

```bash
cm infra scan          # Check all resources exist
cm infra scan --json   # JSON output for automation
```

### Output

**Human-readable:**

```
Infra Scan: my-app
==================

✓ arn:aws:s3:::my-app-data-prod
✓ arn:aws:dynamodb:us-east-1:333333333333:table/my-app-users
✗ arn:aws:lambda:us-east-1:333333333333:function:my-app-api

Found: 2/3
Missing: 1
```

**JSON output (`--json`):**

```json
{
  "passed": false,
  "project": "my-app",
  "summary": {
    "total": 3,
    "found": 2,
    "missing": 1
  },
  "resources": [
    { "arn": "arn:aws:s3:::my-app-data-prod", "exists": true },
    {
      "arn": "arn:aws:dynamodb:us-east-1:333333333333:table/my-app-users",
      "exists": true
    },
    {
      "arn": "arn:aws:lambda:us-east-1:333333333333:function:my-app-api",
      "exists": false
    }
  ]
}
```

### Exit Codes

| Code | Meaning                    |
| ---- | -------------------------- |
| 0    | All resources exist        |
| 1    | One or more resources missing |
| 2    | Configuration error        |
| 3    | Runtime error (AWS access) |

---

## AWS Authentication

Uses standard AWS credential chain:

- Environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
- AWS profiles (`~/.aws/credentials`)
- IAM roles (EC2 instance profile, ECS task role, etc.)

```bash
# Using a specific profile
AWS_PROFILE=prod cm infra scan
```

---

## Supported Resource Types

The scan checks existence by parsing the ARN and calling the appropriate AWS API:

| Service    | ARN Pattern                                      | Check Method         |
| ---------- | ------------------------------------------------ | -------------------- |
| S3         | `arn:aws:s3:::bucket-name`                       | HeadBucket           |
| Lambda     | `arn:aws:lambda:region:account:function:name`    | GetFunction          |
| DynamoDB   | `arn:aws:dynamodb:region:account:table/name`     | DescribeTable        |
| SQS        | `arn:aws:sqs:region:account:queue-name`          | GetQueueAttributes   |
| SNS        | `arn:aws:sns:region:account:topic-name`          | GetTopicAttributes   |
| IAM Role   | `arn:aws:iam::account:role/name`                 | GetRole              |
| IAM Policy | `arn:aws:iam::account:policy/name`               | GetPolicy            |
| Secrets    | `arn:aws:secretsmanager:region:account:secret:*` | DescribeSecret       |
| CloudWatch | `arn:aws:logs:region:account:log-group:name`     | DescribeLogGroups    |

Additional resource types can be added as needed.

---

## Implementation

```
src/infra/
├── index.ts           # Domain runner, CLI integration
├── scan.ts            # Main scan logic
├── manifest.ts        # Manifest parsing (JSON/text)
└── checkers/
    ├── index.ts       # Checker registry by service
    ├── s3.ts          # S3 existence check
    ├── lambda.ts      # Lambda existence check
    ├── dynamodb.ts    # DynamoDB existence check
    └── ...            # Other services
```

**Dependencies (lazy-loaded per service):**

- `@aws-sdk/util-arn-parser` - Parse ARN components
- `@aws-sdk/client-s3` - S3 checks
- `@aws-sdk/client-lambda` - Lambda checks
- `@aws-sdk/client-dynamodb` - DynamoDB checks
- (other clients as needed based on manifest contents)

---

## Integration with drift-toolkit

drift-toolkit can call check-my-toolkit programmatically:

```typescript
import { scanInfra } from "check-my-toolkit";

const result = await scanInfra({
  manifestPath: "./infra-manifest.json",
});

if (!result.passed) {
  // Create GitHub issue for missing resources
}
```

---

## What This Does NOT Do

| Feature                   | Why Not                                         |
| ------------------------- | ----------------------------------------------- |
| Attribute drift detection | Use CloudFormation drift detection for this     |
| Orphaned resource finding | Different problem, requires account-wide scan   |
| IaC parsing               | Manifest contract is simpler and IaC-agnostic   |
| Tagging validation        | Separate concern, could be a CODE domain check  |
| Multi-account management  | ARNs contain account IDs; use AWS_PROFILE       |

---

## Example Workflow

1. **Deploy infrastructure:**

   ```bash
   cd infra/
   sst deploy --stage prod
   # or: cdk deploy
   # or: terraform apply
   ```

2. **Generate manifest** (handled by your infra package):

   ```bash
   # Output: infra-manifest.json with list of ARNs
   ```

3. **Verify resources exist:**

   ```bash
   cm infra scan
   ```

4. **CI/CD integration:**
   ```yaml
   # .github/workflows/deploy.yml
   - name: Deploy
     run: cd infra && sst deploy

   - name: Verify
     run: cm infra scan
   ```
